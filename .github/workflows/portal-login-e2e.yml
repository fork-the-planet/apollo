#
# Copyright 2026 Apollo Authors
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
# http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.
#

name: portal-login-e2e

on:
  pull_request:
    branches: [ master ]
    paths:
      - 'apollo-portal/**'
      - 'apollo-assembly/**'
      - 'e2e/portal-e2e/**'
      - '.github/workflows/portal-login-e2e.yml'

jobs:
  portal-login-e2e:
    name: portal-login-e2e (${{ matrix.mode }})
    runs-on: ubuntu-latest
    timeout-minutes: 120
    strategy:
      fail-fast: false
      matrix:
        mode: [ ldap, oidc ]
    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 17
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: 17
          cache: maven

      - name: Set up Node.js 20
        uses: actions/setup-node@v4
        with:
          node-version: 20

      - name: Cache Playwright browsers
        uses: actions/cache@v4
        with:
          path: ~/.cache/ms-playwright
          key: ${{ runner.os }}-playwright-${{ hashFiles('e2e/portal-e2e/package-lock.json') }}
          restore-keys: |
            ${{ runner.os }}-playwright-

      - name: Build Apollo assembly
        run: ./mvnw -B -pl apollo-assembly -am -DskipTests package

      - name: Setup auth provider
        env:
          PORTAL_BASE_URL: http://127.0.0.1:8070
          LDAP_ALLOWED_USER: apollo
          LDAP_ALLOWED_USER_PASSWORD: admin
          LDAP_ALLOWED_USER_SECONDARY: devops1
          LDAP_ALLOWED_USER_SECONDARY_PASSWORD: admin
          LDAP_ALLOWED_USER_SECONDARY_DISPLAY_NAME: Dev Ops One
          LDAP_ALLOWED_USER_SECONDARY_EMAIL: devops1@example.org
          LDAP_BLOCKED_USER: blocked1
          LDAP_BLOCKED_USER_PASSWORD: admin
          OIDC_USERNAME: apollo
          OIDC_PASSWORD: admin
          OIDC_SECONDARY_USERNAME: oidcdev1
          OIDC_SECONDARY_PASSWORD: admin
          OIDC_SECONDARY_EMAIL: oidcdev1@example.org
          OIDC_CLIENT_ID: apollo-portal
          OIDC_CLIENT_SECRET: apollo-secret
        run: ./e2e/portal-e2e/scripts/auth/setup-${{ matrix.mode }}.sh

      - name: Start Apollo assembly
        env:
          OIDC_ISSUER_URI: http://127.0.0.1:9080/realms/apollo
          OIDC_CLIENT_ID: apollo-portal
          OIDC_CLIENT_SECRET: apollo-secret
        run: |
          JAR=""
          for candidate in apollo-assembly/target/apollo-assembly-*.jar; do
            if [[ "$candidate" == *"-sources.jar" || "$candidate" == *"-javadoc.jar" ]]; then
              continue
            fi
            if [[ -f "$candidate" ]]; then
              JAR="$candidate"
              break
            fi
          done

          if [[ -z "$JAR" ]]; then
            echo "No runnable apollo-assembly jar found in apollo-assembly/target" >&2
            exit 1
          fi

          if [[ "${{ matrix.mode }}" == "ldap" ]]; then
            ACTIVE_PROFILES="github,database-discovery,ldap"
          else
            ACTIVE_PROFILES="github,database-discovery,oidc"
          fi

          SPRING_PROFILES_ACTIVE="${ACTIVE_PROFILES}" \
          SPRING_SQL_CONFIG_INIT_MODE="always" \
          SPRING_SQL_PORTAL_INIT_MODE="always" \
          SPRING_CONFIG_DATASOURCE_URL="jdbc:h2:mem:apollo-config-db;mode=mysql;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;BUILTIN_ALIAS_OVERRIDE=TRUE;DATABASE_TO_UPPER=FALSE" \
          SPRING_PORTAL_DATASOURCE_URL="jdbc:h2:mem:apollo-portal-db;mode=mysql;DB_CLOSE_ON_EXIT=FALSE;DB_CLOSE_DELAY=-1;BUILTIN_ALIAS_OVERRIDE=TRUE;DATABASE_TO_UPPER=FALSE" \
          SPRING_CONFIG_ADDITIONAL_LOCATION="file:${GITHUB_WORKSPACE}/e2e/portal-e2e/config/application-${{ matrix.mode }}-e2e.yml" \
          java -jar "$JAR" > /tmp/apollo-assembly-run.log 2>&1 &

          echo $! > /tmp/apollo-assembly.pid

      - name: Wait for Apollo readiness
        env:
          PORTAL_AUTH_MODE: ${{ matrix.mode }}
          PORTAL_USERNAME: apollo
          PORTAL_PASSWORD: admin
        run: ./e2e/portal-e2e/scripts/wait-for-ready.sh

      - name: Run Playwright auth matrix tests
        env:
          BASE_URL: http://127.0.0.1:8070
          PORTAL_AUTH_MODE: ${{ matrix.mode }}
          PORTAL_USERNAME: apollo
          PORTAL_PASSWORD: admin
          LDAP_ALLOWED_USER: apollo
          LDAP_ALLOWED_USER_PASSWORD: admin
          LDAP_ALLOWED_USER_SECONDARY: devops1
          LDAP_ALLOWED_USER_SECONDARY_DISPLAY_NAME: Dev Ops One
          LDAP_ALLOWED_USER_SECONDARY_EMAIL: devops1@example.org
          LDAP_BLOCKED_USER: blocked1
          LDAP_BLOCKED_USER_PASSWORD: admin
          OIDC_USERNAME: apollo
          OIDC_PASSWORD: admin
          OIDC_SECONDARY_USERNAME: oidcdev1
          OIDC_SECONDARY_PASSWORD: admin
          OIDC_SECONDARY_EMAIL: oidcdev1@example.org
          OIDC_CLIENT_ID: apollo-portal
          OIDC_CLIENT_SECRET: apollo-secret
          OIDC_ISSUER_URI: http://127.0.0.1:9080/realms/apollo
          PLAYWRIGHT_WORKERS: 2
        run: |
          cd e2e/portal-e2e
          npm ci
          npx playwright install chromium
          npm run test:e2e:auth-matrix:ci

      - name: Dump auth provider logs on failure
        if: failure()
        run: |
          docker logs apollo-e2e-ldap > /tmp/apollo-e2e-ldap.log 2>&1 || true
          docker logs apollo-e2e-keycloak > /tmp/apollo-e2e-keycloak.log 2>&1 || true

      - name: Upload auth matrix artifacts on failure
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: portal-login-e2e-artifacts-${{ matrix.mode }}
          path: |
            e2e/portal-e2e/playwright-report
            e2e/portal-e2e/test-results
            /tmp/apollo-assembly-run.log
            /tmp/apollo-e2e-ldap.log
            /tmp/apollo-e2e-keycloak.log

      - name: Stop Apollo assembly
        if: always()
        run: |
          if [ -f /tmp/apollo-assembly.pid ]; then
            kill "$(cat /tmp/apollo-assembly.pid)" || true
          fi

      - name: Teardown auth provider
        if: always()
        run: ./e2e/portal-e2e/scripts/auth/teardown-auth.sh
